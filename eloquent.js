(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?module.exports=t():typeof define==="function"&&define.amd?define(t):e.Eloquent=t()})(this,function(){"use strict";var e={};e.classCallCheck=function(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}};e.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}return function(t,n,r){if(n)e(t.prototype,n);if(r)e(t,r);return t}}();e.inherits=function(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof t)}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:false,writable:true,configurable:true}});if(t)Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t};e.possibleConstructorReturn=function(e,t){if(!e){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return t&&(typeof t==="object"||typeof t==="function")?t:e};e;var t=function(){function t(n,r){e.classCallCheck(this,t);this.connection=n;this.stack=[];this._model=null;if(r)this._setModel(r)}e.createClass(t,[{key:"_call",value:function i(e,t){this.stack.push([e,t]);return this}},{key:"select",value:function u(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("select",t)}},{key:"addSelect",value:function a(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("addSelect",t)}},{key:"distinct",value:function o(){return this._call("distinct",[])}},{key:"where",value:function s(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("where",t)}},{key:"orWhere",value:function l(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhere",t)}},{key:"whereBetween",value:function c(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereBetween",t)}},{key:"orWhereBetween",value:function h(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhereBetween",t)}},{key:"whereNotBetween",value:function f(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereNotBetween",t)}},{key:"orWhereNotBetween",value:function v(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhereNotBetween",t)}},{key:"whereNested",value:function y(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereNested",t)}},{key:"whereExists",value:function d(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereExists",t)}},{key:"orWhereExists",value:function g(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhereExists",t)}},{key:"whereNotExists",value:function k(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereNotExists",t)}},{key:"orWhereNotExists",value:function p(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhereNotExists",t)}},{key:"whereIn",value:function w(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereIn",t)}},{key:"orWhereIn",value:function _(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhereIn",t)}},{key:"whereNotIn",value:function b(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereNotIn",t)}},{key:"orWhereNotIn",value:function m(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhereNotIn",t)}},{key:"whereNull",value:function A(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereNull",t)}},{key:"orWhereNull",value:function E(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhereNull",t)}},{key:"whereNotNull",value:function N(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereNotNull",t)}},{key:"orWhereNotNull",value:function O(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orWhereNotNull",t)}},{key:"whereDate",value:function C(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereDate",t)}},{key:"whereDay",value:function j(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereDay",t)}},{key:"whereMonth",value:function x(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereMonth",t)}},{key:"whereYear",value:function R(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("whereYear",t)}},{key:"groupBy",value:function I(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("groupBy",t)}},{key:"having",value:function B(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("having",t)}},{key:"orHaving",value:function W(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orHaving",t)}},{key:"orderBy",value:function S(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("orderBy",t)}},{key:"latest",value:function P(e){return this._call("latest",e?[e]:[])}},{key:"oldest",value:function M(e){return this._call("oldest",e?[e]:[])}},{key:"offset",value:function q(e){return this._call("offset",[e])}},{key:"skip",value:function D(e){return this._call("skip",[e])}},{key:"limit",value:function H(e){return this._call("limit",[e])}},{key:"take",value:function K(e){return this._call("take",[e])}},{key:"forPage",value:function Q(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}return this._call("forPage",t)}},{key:"with",value:function T(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++){t[n]=arguments[n]}this._call("with",t);return this}},{key:"find",value:function F(e,t){var n=this;if(Array.isArray(e)){return this.findMany(e,t)}return this.connection.read(e).then(function(e){return e?n._model.newInstance(e,true):null})}},{key:"findMany",value:function J(e,t){return this.whereIn(this._model.getKeyName(),e).get(t)}},{key:"findOrFail",value:function U(e,t){return this.find(e,t).then(r)}},{key:"first",value:function X(e){return this.limit(1).get(e).then(n)}},{key:"firstOrFail",value:function Y(e){return this.first(e).then(r)}},{key:"value",value:function z(e){return this.first(e).then(function(t){return t[e]})}},{key:"lists",value:function G(e){return this.get(e).then(function(t){return t.map(function(t){return t[e]})})}},{key:"scope",value:function L(e,t){var n=[e];if(t){n.push(t)}this._call("scope",n);return this}},{key:"get",value:function V(e){var t=this;if(e){this.select(e)}return this.connection.read(this.stack).then(function(e){return t._model.hydrate(e)})}},{key:"insert",value:function Z(e){return this.connection.create(e)}},{key:"update",value:function $(e){return this.connection.update(this.stack,e)}},{key:"delete",value:function ee(){return this.connection.delete(this.stack)}},{key:"_getModel",value:function te(){return this._model}},{key:"_setModel",value:function ne(e){var t=this;this._model=e;(e.constructor.scopes||[]).forEach(function(e){t[e]=function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++){n[r]=arguments[r]}this.scope(e,n);return this}})}}]);return t}();function n(e){return e[0]?e[0]:null}function r(e){if(e===null){throw new Error("ModelNotFoundException")}return e}var i=function(){function t(n){e.classCallCheck(this,t);this.endpoint=n}e.createClass(t,[{key:"create",value:function n(e){var t=this;return this.sendRequest(null,"post",e).then(function(e){return t.unwrap(e)})}},{key:"read",value:function r(e){var t=this;return this.sendRequest(e).then(function(e){return t.unwrap(e)})}},{key:"update",value:function i(e,t){var n=this;return this.sendRequest(e,"put",t).then(function(e){return n.unwrap(e)})}},{key:"delete",value:function a(e){return this.sendRequest(e,"delete").then(function(e){return e.status===200})}},{key:"_fetch",value:function o(e,t,n,r){return fetch(this.url(e,t),this._makeInit(n,r))}},{key:"sendRequest",value:function s(e,t,n){return fetch(this.buildUrl(e),this.buildOptions(t,n))}},{key:"buildUrl",value:function l(e){if(!this.endpoint){throw"Endpoint must be set before using this connection"}var t=this.endpoint;if(Array.isArray(e)){if(e.length){t+="?query="+JSON.stringify(e)}}else if(e){t+="/"+e}return t}},{key:"buildOptions",value:function c(e,t,n){var r={credentials:"same-origin",headers:{Accept:"application/json"}};if(e){r.method=e}if(t){r.headers["Content-Type"]="application/json";r.body=JSON.stringify(t)}return Object.assign(r,n||{})}},{key:"unwrap",value:function h(e){return e.json()}},{key:"url",value:function f(e,t){if(!this.endpoint){throw"Endpoint must be set before using this connection"}var f=this.endpoint;if(e){f+="/"+e}if(t&&t.length){return f+"?query="+JSON.stringify(t)}return f}},{key:"_makeInit",value:function v(e,t,n){var r={credentials:"same-origin",headers:{Accept:"application/json"}};if(e){r.method=e}if(t){r.headers["Content-Type"]="application/json";r.body=JSON.stringify(t)}return Object.assign(r,n||{})}}]);return t}();function u(){if(typeof document==="undefined")return;return decodeURIComponent((document.cookie.match("(^|; )XSRF-TOKEN=([^;]*)")||0)[2])}var a=function(){function t(n){e.classCallCheck(this,t);this.baseClass=n;this.items=new Map}e.createClass(t,[{key:"register",value:function n(e,t,r){var i=void 0;if(typeof t==="function"){i=t}else{i=function u(e){return Object.assign(e,t)}}this.items.set(e,i);return r?this.make(e):this}},{key:"make",value:function r(e){var t=this.items.get(e);if(!t){throw new Error("Model ["+e+"] not registered")}if(!t._made){t._made=this._makeClass(this.baseClass,t)}return t._made}},{key:"_makeClass",value:function i(t,n){var r=n(function(t){e.inherits(n,t);function n(){e.classCallCheck(this,n);return e.possibleConstructorReturn(this,Object.getPrototypeOf(n).apply(this,arguments))}return n}(t));r.prototype.bootIfNotBooted();return r}}]);return t}();var o=function(){function n(){var t=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];e.classCallCheck(this,n);this.bootIfNotBooted();Object.defineProperties(this,{original:{writable:true},exists:{writable:true}});this.exists=false;this.fill(t);this._syncOriginal()}e.createClass(n,[{key:"bootIfNotBooted",value:function r(){if(!this.constructor.booted){this.constructor.boot()}}},{key:"fill",value:function u(e){for(var t in e){this.setAttribute(t,e[t])}return this}},{key:"_syncOriginal",value:function a(){this.original=this.getAttributes()}},{key:"getAttribute",value:function o(e){return this[e]}},{key:"setAttribute",value:function c(e,t){if(t!==null&&this.isDate(e)){t=new Date(t);t.toJSON=l}if(this._isRelation(e)){t=this._makeRelated(e,t)}this[e]=t;return this}},{key:"getAttributes",value:function h(){var e=Object.assign({},this);for(var t in e){if(this.isDate(t)){e[t]=new Date(this[t]);e[t].toJSON=l}if(this._isRelation(t)){delete e[t]}}return e}},{key:"getDirty",value:function f(){var e=this.getAttributes();for(var t in e){if(typeof this.original[t]!=="undefined"&&this.original[t].valueOf()===e[t].valueOf()){delete e[t]}}return e}},{key:"getKey",value:function v(){return this[this.getKeyName()]}},{key:"getKeyName",value:function y(){return this.constructor.primaryKey||"id"}},{key:"isDate",value:function d(e){return this.constructor.dates.concat("created_at","updated_at","deleted_at").indexOf(e)>-1}},{key:"_isRelation",value:function g(e){return Object.keys(this.constructor.relations).indexOf(e)>-1}},{key:"newQuery",value:function k(){return new t(this.connection,this)}},{key:"newInstance",value:function p(){var e=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var t=arguments.length<=1||arguments[1]===undefined?false:arguments[1];var n=new this.constructor(e);n.exists=t;return n}},{key:"hydrate",value:function w(e){var t=this;return e.map(function(e){return t.newInstance(e,true)})}},{key:"save",value:function _(){var e=this;var t=void 0;if(this.triggerEvent("saving")===false){return Promise.reject("saving.cancelled")}if(this.exists){t=this._performUpdate()}else{t=this._performInsert()}return t.then(function(t){e.exists=true;e.triggerEvent("saved",false);return e.fill(t)&&e._syncOriginal()})}},{key:"_performInsert",value:function b(){var e=this;if(this.triggerEvent("creating")===false){return Promise.reject("creating.cancelled")}return this.newQuery().insert(this.getAttributes()).then(function(t){e.triggerEvent("created",false);return t})}},{key:"_performUpdate",value:function m(){var e=this;if(this.triggerEvent("updating")===false){return Promise.reject("updating.cancelled")}return this.connection.update(this.getKey(),this.getDirty()).then(function(t){e.triggerEvent("updated",false);return t})}},{key:"update",value:function A(e){if(!this.exists){return this.newQuery().update(e)}this.fill(e);return this.save()}},{key:"delete",value:function E(){var e=this;if(this.triggerEvent("deleting")===false){return Promise.reject("deleting.cancelled")}return this.connection.delete(this.getKey()).then(function(t){if(t){e.exists=false}e.triggerEvent("deleted",false);return t})}},{key:"load",value:function N(){var e=this;for(var t=arguments.length,n=Array(t),r=0;r<t;r++){n[r]=arguments[r]}return this.newQuery().with(n).first().then(function(t){n.forEach(function(n){e.setAttribute(n,t[n])});return e})}},{key:"_makeRelated",value:function O(e,t){var n=this._getRelatedClass(this.constructor.relations[e]);var r=new n;if(Array.isArray(t)){return r.hydrate(t)}return r.fill(t)}},{key:"_getRelatedClass",value:function C(e){throw new Error("Cannot make related class ["+e+"]")}},{key:"triggerEvent",value:function j(e){var t=arguments.length<=1||arguments[1]===undefined?true:arguments[1];var n=this.constructor.events;for(var r=0,i=(n[e]||[]).length;r<i;++r){var u=n[e][r](this);if(t&&typeof u!=="undefined"){return u}}}}],[{key:"boot",value:function x(){if(!n.booted){this._bootBaseModel()}this._bootSelf()}},{key:"_bootSelf",value:function R(){this.booted=true;this.dates=this.dates||[];this.relations=this.relations||{};this.scopes=this.scopes||[];if(!this.prototype.connection)this.prototype.connection=new i(this.endpoint);this._bootScopes(this.scopes)}},{key:"_bootBaseModel",value:function I(){this.events={};var e=Object.getPrototypeOf(new t);Object.getOwnPropertyNames(e).filter(function(t){return t.charAt(0)!=="_"&&t!=="constructor"&&typeof e[t]==="function"}).forEach(function(e){s(n.prototype,e,function(){var t=this.newQuery();return t[e].apply(t,arguments)});s(n,e,function(){var t=this.query();return t[e].apply(t,arguments)})})}},{key:"_bootScopes",value:function B(e){e.forEach(function(e){s(this,e,function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++){n[r]=arguments[r]}return this.newQuery().scope(e,n)});s(this.constructor,e,function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++){n[r]=arguments[r]}return this.query().scope(e,n)})},this.prototype)}},{key:"query",value:function W(){return(new this).newQuery()}},{key:"create",value:function S(){var e=arguments.length<=0||arguments[0]===undefined?{}:arguments[0];var t=new this(e);return t.save().then(function(){return t})}},{key:"all",value:function P(e){return(new this).newQuery().get(e)}},{key:"setContainer",value:function M(e){this.prototype._getRelatedClass=function(t){return e.make(t)}}},{key:"creating",value:function q(e){this.registerEventHandler("creating",e)}},{key:"created",value:function D(e){this.registerEventHandler("created",e)}},{key:"updating",value:function H(e){this.registerEventHandler("updating",e)}},{key:"updated",value:function K(e){this.registerEventHandler("updated",e)}},{key:"saving",value:function Q(e){this.registerEventHandler("saving",e)}},{key:"saved",value:function T(e){this.registerEventHandler("saved",e)}},{key:"deleting",value:function F(e){this.registerEventHandler("deleting",e)}},{key:"deleted",value:function J(e){this.registerEventHandler("deleted",e)}},{key:"registerEventHandler",value:function U(e,t){if(!this.events[e])this.events[e]=[];this.events[e].push(t)}}]);return n}();function s(e,t,n,r){if(typeof e[t]!=="undefined"&&!r){return e}return Object.defineProperty(e,t,{value:n})}function l(){return Math.round(this.valueOf()/1e3)}var c=void 0;var h=function f(e,t){if(!c){c=new a(o);o.setContainer(c)}if(t){Object.defineProperty(f,e,{get:function n(){return c.make(e)}});return c.register(e,t)}return c.make(e)};h.Builder=t;h.Container=a;h.Model=o;h.RestConnection=i;return h});